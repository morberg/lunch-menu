<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lund Lunch Menus</title>
    <style>
        body {
            font-family: 'Avenir Next', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #dad7cd;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #344e41;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .restaurant {
            background: #eae7dd;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px #cac7bd;
        }

        .day-section {
            margin-bottom: 20px;
        }

        .day-title {
            font-weight: bold;
            color: #3a5a40;
            font-size: 18px;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #588157;
        }

        .menu-item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .menu-item-price {
            color: #344e41;
            float: right;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
        }

        th,
        td {
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #f0f0f0;
            font-size: 15px;
        }

        td {
            border-top: 1px solid #eee;
        }

        @media (max-width: 600px) {
            body {
                padding: 6px;
            }

            .restaurant {
                padding: 7px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Dagens Lunch</h1>
    </header>

    <main>
        <div id="loading" class="loading">
            Laddar menyer...
        </div>

        <div id="content" style="display: none;">
            <!-- Menu content will be loaded here -->
        </div>
    </main>

    <script>
        async function loadMenus() {
            try {
                const response = await fetch('/api/menus');
                const data = await response.json();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                displayMenus(data);
            } catch (error) {
                document.getElementById('loading').innerHTML =
                    '<div class="error">Kunde inte ladda menyer. Försök igen senare.</div>';
                console.error('Error loading menus:', error);
            }
        }
        function displayMenus(data) {
            const content = document.getElementById('content');
            content.innerHTML = '';
            // Swedish day names
            // Map day keys to Swedish labels for display and filtering
            const dayMap = {
                'Måndag': 'Måndag',
                'Tisdag': 'Tisdag',
                'Onsdag': 'Onsdag',
                'Torsdag': 'Torsdag',
                'Fredag': 'Fredag',
                'Weekly Special': 'Veckans vegetariska',
                'Monthly Special': 'Månadens alternativ'
            };
            const days = Object.values(dayMap);
            const restaurants = [
                { name: 'Edison', data: data.edison, url: 'https://restaurangedison.se/lunch/' },
                { name: 'Grenden', data: data.grenden, url: 'https://lund.pieplowsmat.se/grenden/' },
                { name: 'Bricks Eatery', data: data.bricks, url: 'https://brickseatery.se/lunch/' },
                { name: 'Kantin', data: data.kantin, url: 'https://www.kantinlund.se/' },
                { name: 'Smakapakina', data: data.smakapakina, url: 'https://www.smakapakina.se/meny' },
                { name: 'Eatery', data: data.eatery, url: 'https://eatery.se/anlaggningar/lund' },
            ];
            days.forEach(daySv => {
                let hasMenus = false;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-section';
                dayDiv.innerHTML = `<div class="day-title">${daySv}</div>`;
                restaurants.forEach(r => {
                    // Find the key for this Swedish label
                    const dayKey = Object.keys(dayMap).find(key => dayMap[key] === daySv);
                    const items = (r.data || []).filter(item => item.day === daySv || item.day === dayKey);
                    if (items.length > 0) {
                        hasMenus = true;

                        // Check if all items have the same price
                        const prices = items.map(item => item.price);
                        const uniquePrices = [...new Set(prices)];
                        const hasUniformPrice = uniquePrices.length === 1;
                        const uniformPrice = hasUniformPrice ? uniquePrices[0] : null;

                        const restaurantDiv = document.createElement('div');
                        restaurantDiv.className = 'restaurant';

                        // Restaurant name with price if uniform
                        let restaurantHeader = `<strong><a href="${r.url}" target="_blank" style="color: inherit; text-decoration: none;">${r.name}</a></strong>`;
                        if (hasUniformPrice && uniformPrice !== null) {
                            restaurantHeader += ` <span class="menu-item-price">${uniformPrice} kr</span>`;
                        }
                        // If uniformPrice is null, don't display anything
                        restaurantDiv.innerHTML = restaurantHeader;

                        // Table for all menu items of this restaurant for this day
                        const table = document.createElement('table');
                        table.style.width = '100%';
                        table.style.borderCollapse = 'collapse';
                        table.style.marginBottom = '4px';
                        table.innerHTML = `<tbody></tbody>`;
                        const tbody = table.querySelector('tbody');
                        items.forEach(item => {
                            const tr = document.createElement('tr');

                            if (hasUniformPrice) {
                                // Only show dish name when all prices are the same
                                tr.innerHTML = `
                                    <td style="padding:4px 6px;vertical-align:top;">${item.name}</td>
                                `;
                            } else {
                                // Show both dish name and individual price when prices differ
                                let price;
                                if (item.price !== null && item.price !== undefined) {
                                    price = `${item.price} kr`;
                                } else {
                                    price = '-';
                                }
                                tr.innerHTML = `
                                    <td style="padding:4px 6px;vertical-align:top;">${item.name}</td>
                                    <td style="padding:4px 6px;text-align:right;vertical-align:top;color:#28a745;">${price}</td>
                                `;
                            }
                            tbody.appendChild(tr);
                        });
                        restaurantDiv.appendChild(table);
                        dayDiv.appendChild(restaurantDiv);
                    }
                });
                if (hasMenus) {
                    content.appendChild(dayDiv);
                }
            });
            // Show message if no menus available
            if (!data.edison?.length && !data.bricks?.length && !data.kantin?.length && !data.smakapakina?.length && !data.grenden?.length && !data.eatery?.length) {
                content.innerHTML = '<div class="error">Inga menyer tillgängliga just nu. Försök igen senare.</div>';
            }
            // --- Automatic scroll to today's section ---
            const today = new Date();
            const swedishDays = ['Söndag', 'Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lördag'];
            const todayName = swedishDays[today.getDay()];
            // Only scroll if today is a weekday (Måndag-Fredag)
            if (['Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag'].includes(todayName)) {
                // Find the first .day-title matching today
                const dayTitles = document.querySelectorAll('.day-title');
                for (const el of dayTitles) {
                    if (el.textContent.trim() === todayName) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        break;
                    }
                }
            }
        }
        window.addEventListener('DOMContentLoaded', loadMenus);
    </script>
</body>

</html>