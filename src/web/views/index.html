<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lund Lunch Menus</title>
    <style>
        body {
            font-family: 'Avenir Next', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #dad7cd;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #344e41;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .restaurant {
            background: #faf7ed;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px #cac7bd;
        }

        .day-section {
            margin-bottom: 20px;
        }

        .day-title {
            font-weight: bold;
            color: #3a5a40;
            font-size: 18px;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #588157;
        }

        .menu-item-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .menu-item-price {
            color: #344e41;
            float: right;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
        }

        th,
        td {
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #f0f0f0;
            font-size: 15px;
        }

        td {
            border-top: 1px solid #eee;
        }

        .hidden {
            display: none !important;
        }

        .restaurant-link {
            color: inherit;
            text-decoration: none;
        }

        .menu-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 4px;
        }

        .cell {
            padding: 4px 6px;
            vertical-align: top;
        }

        .cell-price {
            padding: 4px 6px;
            text-align: right;
            vertical-align: top;
            color: #28a745;
        }

        .placeholder-note {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        .restaurant-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .restaurant-title-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toggle-btn {
            background: none;
            border: 1px solid #588157;
            color: #344e41;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            line-height: 1.2;
        }

        .toggle-btn:hover {
            background: #588157;
            color: #fff;
        }

        .restaurant.collapsed .restaurant-content {
            display: none;
        }

        .restaurant.collapsed {
            opacity: 0.7;
        }

        @media (max-width: 600px) {
            body {
                padding: 6px;
            }

            .restaurant {
                padding: 7px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Dagens Lunch</h1>
    </header>

    <main>
        <div id="loading" class="loading">
            Laddar menyer...
        </div>

        <div id="content" class="hidden"></div>
    </main>

    <script>
        async function loadMenus() {
            try {
                const response = await fetch('/api/menus');
                const data = await response.json();
                document.getElementById('loading').classList.add('hidden');
                const contentEl = document.getElementById('content');
                contentEl.classList.remove('hidden');
                displayMenus(data);
            } catch (error) {
                const loading = document.getElementById('loading');
                loading.innerHTML = '<div class="error">Kunde inte ladda menyer. Försök igen senare.</div>';
                console.error('Error loading menus:', error);
            }
        }

        function displayMenus(data) {
            const content = document.getElementById('content');
            content.innerHTML = '';
            const days = ['Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'Hela veckan'];
            const dayMapping = { 'Monday': 'Måndag', 'Tuesday': 'Tisdag', 'Wednesday': 'Onsdag', 'Thursday': 'Torsdag', 'Friday': 'Fredag', 'Hela veckan': 'Hela veckan' };
            const restaurants = [
                { name: 'Edison', key: 'edison', data: data.edison, url: 'https://restaurangedison.se/lunch/' },
                { name: 'Grenden', key: 'grenden', data: data.grenden, url: 'https://www.nordrest.se/restaurang/grenden/' },
                { name: 'Food Hall', key: 'foodhall', data: data.foodhall, url: 'https://www.nordrest.se/restaurang/food-hall/', weeklyOnly: true },
                { name: 'Bricks Eatery', key: 'bricks', data: data.bricks, url: 'https://brickseatery.se/lunch/' },
                { name: 'Kantin', key: 'kantin', data: data.kantin, url: 'https://www.kantinlund.se/' },
                { name: 'Smakapakina', key: 'smakapakina', data: data.smakapakina, url: 'https://www.smakapakina.se/meny' },
                { name: 'Eatery', key: 'eatery', data: data.eatery, url: 'https://eatery.se/anlaggningar/lund' },
            ];

            const restaurantsWithAnyItems = new Set();
            restaurants.forEach(r => { if (Array.isArray(r.data) && r.data.length > 0) restaurantsWithAnyItems.add(r.key); });

            const collapsedKey = 'collapsedRestaurantsV1';
            const collapsed = new Set(JSON.parse(localStorage.getItem(collapsedKey) || '[]'));
            function persist() { localStorage.setItem(collapsedKey, JSON.stringify([...collapsed])); }
            function buildRestaurantHeader(r, hasUniformPrice, uniformPrice) {
                const isCollapsed = collapsed.has(r.key);
                const priceSpan = (hasUniformPrice && uniformPrice !== null) ? `<span class="menu-item-price">${uniformPrice} kr</span>` : '';
                return `<div class="restaurant-header">
  <div class="restaurant-title-wrap">
    <button class="toggle-btn" data-rest="${r.key}" aria-expanded="${!isCollapsed}">${isCollapsed ? '+' : '−'}</button>
    <strong><a href="${r.url}" target="_blank" class="restaurant-link">${r.name}</a></strong>${priceSpan}
  </div>
</div>`;
            }
            function applyToggleHandlers(scope) {
                scope.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const key = btn.getAttribute('data-rest');
                        if (collapsed.has(key)) collapsed.delete(key); else collapsed.add(key);
                        persist();
                        // Update all instances
                        document.querySelectorAll(`.restaurant[data-rest='${key}']`).forEach(div => {
                            if (collapsed.has(key)) div.classList.add('collapsed'); else div.classList.remove('collapsed');
                            // Update button symbol & aria
                            div.querySelectorAll(`.toggle-btn[data-rest='${key}']`).forEach(b => {
                                const isCol = collapsed.has(key);
                                b.textContent = isCol ? '+' : '−';
                                b.setAttribute('aria-expanded', String(!isCol));
                            });
                        });
                    });
                });
            }

            content.innerHTML = '';
            days.forEach(daySv => {
                let anyRestaurantShown = false;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-section';
                dayDiv.innerHTML = `<div class="day-title">${daySv}</div>`;
                restaurants.forEach(r => {
                    if (r.weeklyOnly && daySv !== 'Hela veckan') {
                        return; // Skip Food Hall for weekday sections
                    }
                    const items = (r.data || []).filter(item => item.day === daySv || dayMapping[item.day] === daySv);
                    const restaurantDiv = document.createElement('div');
                    restaurantDiv.className = 'restaurant';
                    restaurantDiv.dataset.rest = r.key;
                    const isCollapsed = collapsed.has(r.key);
                    if (items.length > 0) {
                        anyRestaurantShown = true;
                        const prices = items.map(i => i.price);
                        const uniquePrices = [...new Set(prices)];
                        const hasUniformPrice = uniquePrices.length === 1;
                        const uniformPrice = hasUniformPrice ? uniquePrices[0] : null;
                        restaurantDiv.innerHTML = buildRestaurantHeader(r, hasUniformPrice, uniformPrice);
                        const contentWrap = document.createElement('div');
                        contentWrap.className = 'restaurant-content';
                        const table = document.createElement('table');
                        table.className = 'menu-table';
                        table.innerHTML = '<tbody></tbody>';
                        const tbody = table.querySelector('tbody');
                        items.forEach(item => {
                            const tr = document.createElement('tr');
                            if (hasUniformPrice) {
                                tr.innerHTML = `<td class="cell">${item.name}</td>`;
                            } else {
                                const price = (item.price !== null && item.price !== undefined) ? `${item.price} kr` : '-';
                                tr.innerHTML = `<td class="cell">${item.name}</td><td class="cell-price">${price}</td>`;
                            }
                            tbody.appendChild(tr);
                        });
                        contentWrap.appendChild(table);
                        restaurantDiv.appendChild(contentWrap);
                    } else if (['Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag'].includes(daySv)) {
                        anyRestaurantShown = true;
                        restaurantDiv.innerHTML = buildRestaurantHeader(r, false, null);
                        const contentWrap = document.createElement('div');
                        contentWrap.className = 'restaurant-content';
                        contentWrap.innerHTML = `<div class="placeholder-note">Ingen meny hittades för ${daySv.toLowerCase()}. Klicka för att besöka.</div>`;
                        restaurantDiv.appendChild(contentWrap);
                    } else {
                        return; // skip adding empty weekly section entries
                    }
                    if (isCollapsed) restaurantDiv.classList.add('collapsed');
                    dayDiv.appendChild(restaurantDiv);
                });
                if (anyRestaurantShown) content.appendChild(dayDiv);
            });

            // Section listing restaurants with zero items all week
            const emptyRestaurants = restaurants.filter(r => !(restaurantsWithAnyItems.has(r.key)));
            if (emptyRestaurants.length) {
                const section = document.createElement('div');
                section.className = 'day-section';
                section.innerHTML = '<div class="day-title">Restauranger utan menydata</div>';
                emptyRestaurants.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'restaurant';
                    div.dataset.rest = r.key;
                    const isCollapsed = collapsed.has(r.key);
                    div.innerHTML = buildRestaurantHeader(r, false, null) + `<div class="restaurant-content"><div class="placeholder-note">Ingen meny kunde hämtas. Klicka för att besöka deras sida.</div></div>`;
                    if (isCollapsed) div.classList.add('collapsed');
                    section.appendChild(div);
                });
                content.appendChild(section);
            }

            applyToggleHandlers(document);

            // Auto-scroll remains same
            const today = new Date();
            const swedishDays = ['Söndag', 'Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lördag'];
            const todayName = swedishDays[today.getDay()];
            if (['Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag'].includes(todayName)) {
                const dayTitles = document.querySelectorAll('.day-title');
                for (const el of dayTitles) { if (el.textContent.trim() === todayName) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); break; } }
            }
        }
        window.addEventListener('DOMContentLoaded', loadMenus);
    </script>
</body>

</html>